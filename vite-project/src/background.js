const ioGames = [
  "flixter.io",
  "drednot.io",
  "agar.io",
  "agar.red",
  "craftnite.io",
  "acolytefight.io",
  "biome3d.com",
  "anomal.io",
  "antwar.io",
  "aquapark.io",
  "aquar.io",
  "arrow.io",
  "astr.io",
  "astro.io",
  "astrar.io",
  "astroe.io",
  "arras.io",
  "bacter.io",
  "bacterio.ca",
  "battleboats.io",
  "battledudes.io",
  "battleshipgame.io",
  "basher.io",
  "bellum.io",
  "bighunter.io",
  "bist.io",
  "biters.io",
  "blable.io",
  "blackhole.io",
  "blastarena.io",
  "blobe.io",
  "blobie.io",
  "blockor.io",
  "blong.io",
  "bloxd.io",
  "boas.io",
  "boattle.io",
  "bombsgame.io",
  "bonk.io",
  "braains.io",
  "brutal.io",
  "brutalmania.io",
  "brutes.io",
  "bubblebee.io",
  "bubbletrouble.io",
  "buildroyale.io",
  "bumper.io",
  "cararena.io",
  "carball.io",
  "cardgames.io",
  "catac.io",
  "cavegame.io",
  "cellcraft.io",
  "cellix.io",
  "chompers.io",
  "circu.io",
  "clay.io",
  "connect.io",
  "copter.io",
  "crazysteve.io",
  "crossy.io",
  "curvefever.io",
  "curvefever2.io",
  "deadshot.io",
  "deeeep.io",
  "defly.io",
  "devast.io",
  "diep.io",
  "digdig.io",
  "doblons.io",
  "dodgeballs.io",
  "dogargame.io",
  "dotz.io",
  "dragon.io",
  "drednot.io",
  "driftin.io",
  "eatme.io",
  "electoral.io",
  "elemantar.io",
  "elites.io",
  "evowars.io",
  "evoworld.io",
  "ev.io",
  "facepunch.io",
  "farmers.io",
  "fightarena.io",
  "fisp.io",
  "flar.io",
  "florr.io",
  "generals.io",
  "germs.io",
  "globule.io",
  "goons.io",
  "gota.io",
  "gpop.io",
  "gravitygame.io",
  "gungame.io",
  "gunr.io",
  "hexagor.io",
  "hexanaut.io",
  "hexar.io",
  "hexasnakeonline.com",
  "hilly.io",
  "hole.io",
  "hops.io",
  "hopz.io",
  "hordes.io",
  "hunt.io",
  "jellies.io",
  "jomp.io",
  "jukegame.io",
  "kartwars.io",
  "kingz.io",
  "knife.io",
  "krew.io",
  "krunker.io",
  "landix.io",
  "lazardrive.io",
  "lazr.io",
  "leevz.io",
  "littlebigsnake.io",
  "lolbeans.io",
  "lolo.games",
  "looz.io",
  "lordz.io",
  "losts.io",
  "lumen.io",
  "lurkers.io",
  "massacre.io",
  "massivematch.io",
  "match.io",
  "match2.io",
  "maze.io",
  "meduzzza.io",
  "minesweeper.io",
  "minigiants.io",
  "mobg.io",
  "moomoo.io",
  "mope.io",
  "mudwars.io",
  "myball.io",
  "myfrog.io",
  "mypuppet.io",
  "nafk.io",
  "narwhale.io",
  "nbk.io",
  "nightwalkers.io",
  "ninja.io",
  "occup.io",
  "oceanar.io",
  "opka.io",
  "orn.io",
  "overmind.io",
  "pacman.io",
  "paper.io",
  "petridish.io",
  "pikan.io",
  "pikes.io",
  "pirac.io",
  "piranh.io",
  "planes.io",
  "potato.io",
  "ppep.io",
  "prisonlifegame.com",
  "pung.io",
  "racegame.io",
  "rangersteve.io",
  "realmz.io",
  "roams.io",
  "rops.io",
  "rubin.io",
  "salmonz.io",
  "sattelite.io",
  "scenexe.io",
  "scorpo.io",
  "seadragons.io",
  "sf.io",
  "shapez.io",
  "share.io",
  "shark.io",
  "shellshock.io",
  "shipz.io",
  "shooter.io",
  "shooters.io",
  "skap.io",
  "sketchwar.io",
  "skribbl.io",
  "skyfight.io",
  "skyroyale.io",
  "sl4sh.io",
  "slain.io",
  "slice.io",
  "slimes.io",
  "slither.io",
  "slither3d.io",
  "smashers.io",
  "smashkarts.io",
  "smashycars.io",
  "snack.io",
  "snail.io",
  "snakeblast.io",
  "snakepit.io",
  "snaker.io",
  "snix.io",
  "snowball.io",
  "snowfight.io",
  "snowheroes.io",
  "space.io",
  "space1.io",
  "spaceships.io",
  "splashwars.io",
  "splix.io",
  "stabfish.io",
  "starblast.io",
  "starve.io",
  "stomped.io",
  "stug.io",
  "superhex.io",
  "superorbit.io",
  "supersnake.io",
  "suprem.io",
  "surviv.io",
  "taming.io",
  "tankar.io",
  "tanksmith.io",
  "tankwars.io",
  "tanx.io",
  "tenk.io",
  "tenz.io",
  "territorial.io",
  "tetr.io",
  "tiles.io",
  "tron.io",
  "twix.io",
  "vanar.io",
  "vanis.io",
  "vertix.io",
  "venge.io",
  "voar.io",
  "voxiom.io",
  "warcall.io",
  "wilds.io",
  "wings.io",
  "wormate.io",
  "wormax.io",
  "wormszone.io",
  "writhe.io",
  "xess.io",
  "xgun.io",
  "xpilot.io",
  "yorg.io",
  "zlap.io",
  "zlax.io",
  "zombiecraft.io",
  "zombs.io",
  "zombsroyale.io",
];

const reset_categories = () => {
  chrome.storage.local.set({
    // todo: make categories updateable
    categories: {
      work: {
        icon: "SVG",
        background: "COLOR",
        text: "COLOR",
        urls: [
          "github.com",
          "docs.google.com",
          "notion.so",
          "whatsapp.com",
          "wikipedia.org",
          "chatgpt.com",
          "claude.ai",
          "baidu.com",
          "bing.com",
          "linkedin.com",
          "live.com",
          "office.com",
          "microsoft.com",
          "mail.ru",
          "samsung.com",
          "sharepoint.com",
          "duckduckgo.com",
          "zoom.us",
          "amazon.com",
          "t.me",
          "canva.com",
          "extensions",
        ],
      },
      fun: {
        icon: "SVG",
        background: "COLOR",
        text: "COLOR",
        urls: [
          "youtube.com",
          "facebook.com",
          "instagram.com",
          "x.com",
          "reddit.com",
          "tiktok.com",
          "netflix.com",
          "pornhub.com",
          "dzen.ru",
          "naver.com",
          "xvideos.com",
          "twitch.tv",
          "fandom.com",
          "quora.com",
          "twitter.com",
          "kwai-video.com",
          "open.spotify.com",
          ...ioGames,
        ],
      },
      other: {
        icon: "SVG",
        background: "COLOR",
        text: "COLOR",
        urls: [],
      }, // starts out empty
    },
  });
};

reset_categories();

chrome.storage.local.get("categories", (categories) => {
  if (categories == undefined) {
    reset_categories();
  }
});

chrome.storage.local.set({ tooltip: true });

//SITE TEMPLATE:

// {"SITE URL": [
//     {"begin": "STAMP", "end": "STAMP"},
//     {"begin": "STAMP", "end": "STAMP"},
//     {"begin": "STAMP", "end": "STAMP"},
//     {"begin": "STAMP", "end": "STAMP"}
//   ],
//   "SITE URL": [
//     {"begin": "STAMP", "end": "STAMP"},
//     {"begin": "STAMP", "end": "STAMP"},
//     {"begin": "STAMP", "end": "STAMP"},
//     {"begin": "STAMP", "end": "STAMP"}
//   ],
//   ...
// }

// our site template means we get the timestamp for when they go onto a site and when they leave

// every 10 seconds see if the user is on the same tab
// if so, update the final timestamp for the user to be whatever time it is now
// otherwise, go to the next tab and append a new timestamp
let COMPUTER_ON = true;
const WAIT = 1;
let last_updated = ""; // when last updated we push a new value

// returns a `tabs.Tab` or `undefined`
const getCurrentTab = async () => {
  let [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
  return tab;
};

const getCurrentData = async () => {
  let data = await chrome.storage.local.get("site-stats");
  if (data == undefined || data == null || Object.keys(data).length === 0)
    return (
      {
        "site-stats": {},
      }
    );

  return data;
};

const update_timestamps = async (tab) => {
  let t = await chrome.tabs.get(tab.id);
  let url = new URL(t.url).hostname;

  // domain of URL
  try {
    // structure as seen above
    let current_data = await getCurrentData();
    current_data = current_data["site-stats"];

    // if we haven't switched sites yet, update final stamp
    // otherwise push and set new site

    if (last_updated == url) {
      // change final timestamp here

      current_time = new Date().getTime();
      let focused_data = current_data[url];
      current_data[url][focused_data.length - 1].end = current_time;
    } else {
      // push new value to json

      if (url == "") return;
      if (!current_data[url]) current_data[url] = [];
      current_time = new Date().getTime();
      current_data[url].push({ begin: current_time, end: current_time });

      // set last_updated to tab.url, will go to the top code after this
      last_updated = url;
    }

    //console.error(JSON.stringify(current_data))
    chrome.storage.local.set({ "site-stats": current_data });
  } catch (err) {
    console.error(err);
    console.error(JSON.stringify(t));
  }
};

const update = async () => {
  let tab = await getCurrentTab();
  if (tab != undefined) {
    update_timestamps(tab);
  }
};

setInterval(() => {
  if (COMPUTER_ON) update();
}, 1000 * WAIT);

chrome.windows.onFocusChanged.addListener((windowId) => {
  if (windowId === chrome.windows.WINDOW_ID_NONE) {
    // Chrome window has lost focus
    pauseBackgroundOperations();
  } else {
    // Chrome window has gained focus
    resumeBackgroundOperations();
  }
});

function pauseBackgroundOperations() {
  // Code to pause or reduce background operations
  COMPUTER_ON = false;
  last_updated = "";
}

function resumeBackgroundOperations() {
  // Code to resume normal background operations
  COMPUTER_ON = true;
}

if (chrome.idle) {
  // Listen for system state changes
  chrome.idle.onStateChanged.addListener((state) => {
    if (state === "active") {
      resumeBackgroundOperations();
    } else if (state === "idle" || state === "locked") {
      pauseBackgroundOperations();
    }
  });

  // Set up idle detection (e.g., consider system idle after 5 minutes)
  chrome.idle.setDetectionInterval(15);
}
